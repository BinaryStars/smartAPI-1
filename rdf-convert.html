<!DOCTYPE html>
<html ng-app="myApp">

<head>
    <meta charset="utf-8">
	<title>RDF Experiments</title>
	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular-sanitize.js"></script>
	<script src="n3-browser.min.js"></script>
	<!--<script src="triplestore.js" type="text/javascript"></script>-->
</head>

<body>

	<div ng-controller="translation"> 

		<h1>RDF Experiments</h1>
		<form ng-submit="translate()">
			<h2>Type in JSON-LD:</h2>
			<textarea id="userIn" name="userIn" rows="15" cols="50" ng-model="userIn"></textarea>
			<br />
			<input type="submit" id="convert" name="convert" length="20" value="Convert!"/>
		</form>

		<h2>Input (JSON-LD)</h2>
		<pre>{{dataIn}}</pre>

		<h2>Output (N-Triples)</h2>
		<pre>{{dataOut}}</pre>

	</div>


	<script>

	//ANGULAR-JS
		var app = angular.module("myApp", ['ngSanitize'], function($httpProvider){

		//CREDIT: http://victorblog.com/2012/12/20/make-angularjs-http-service-behave-like-jquery-ajax/
			// Use x-www-form-urlencoded Content-Type
			 $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

			  /**
			   * The workhorse; converts an object to x-www-form-urlencoded serialization.
			   * @param {Object} obj
			   * @return {String}
			   */ 
			  var param = function(obj) {
			    var query = '', name, value, fullSubName, subName, subValue, innerObj, i;
			      
			    for(name in obj) {
			      value = obj[name];
			        
			      if(value instanceof Array) {
			        for(i=0; i<value.length; ++i) {
			          subValue = value[i];
			          fullSubName = name + '[' + i + ']';
			          innerObj = {};
			          innerObj[fullSubName] = subValue;
			          query += param(innerObj) + '&';
			        }
			      }
			      else if(value instanceof Object) {
			        for(subName in value) {
			          subValue = value[subName];
			          fullSubName = name + '[' + subName + ']';
			          innerObj = {};
			          innerObj[fullSubName] = subValue;
			          query += param(innerObj) + '&';
			        }
			      }
			      else if(value !== undefined && value !== null)
			        query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
			    }
			      
			    return query.length ? query.substr(0, query.length - 1) : query;
			  };

			  // Override $http service's default transformRequest
			  $httpProvider.defaults.transformRequest = [function(data) {
			    return angular.isObject(data) && String(data) !== '[object File]' ? param(data) : data;
			  }];
		  //END CREDIT

		});

		app.controller("translation", ['$scope', '$http', '$templateCache', function($scope, $http, $templateCache) {

			$scope.dataIn = "";
			$scope.dataOut = "";
			$scope.url = "http://rdf-translator.appspot.com/convert/json-ld/nt/content";

			$scope.translate = function() {

                //console.trace();

				//HTTP POST TO RDF TRANSLATOR REST API
				var req = $http.post($scope.url, { content : $scope.userIn });

				req.success(function(data, status) {
					$scope.dataIn = $scope.userIn;
					$scope.dataOut = data;
				});

				req.error(function(data, status) {
					$scope.dataIn = $scope.userIn;
					$scope.dataOut = data;
				});

				//N3.JS RDF PARSER
				var parser = N3.Parser();
				var store = N3.Store();

				parser.parse($scope.dataOut,
		         function (error, triple, prefixes) {
		           if (triple) {
		             console.log(triple.subject, triple.predicate, triple.object, '.');
		             store.addTriple(triple);
	               }
		           else {
		             console.log("# Loading completed; the store contains %d triples", store.count());
                     done();
	               }
		        });

                function done() {
                    //N3.JS RDF RETRIEVAL FROM STORAGE
                    var republic = store.find('http://example.org/library/the-republic', null, null)[0];
                    if (republic) {
                        console.log(republic.subject, republic.predicate, republic.object);
                        //console.log(republic);
                    }
                }

			};

		}]);



	</script>

</body>
</html>
